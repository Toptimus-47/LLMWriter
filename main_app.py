{"cells":[{"cell_type":"code","source":"# main_app.py\nimport streamlit as st\nimport os\nfrom services.novel_service import NovelService\nfrom models.character import Character\n\n# --- í˜ì´ì§€ ì„¤ì • ---\nst.set_page_config(page_title=\"AI ì†Œì„¤ ì–´ì‹œìŠ¤í„´íŠ¸\", layout=\"wide\")\n\n# --- ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ---\n# ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ëŠ” í•œ ë²ˆë§Œ ìƒì„±í•˜ì—¬ st.session_stateì— ì €ì¥\nif 'novel_service' not in st.session_state:\n    st.session_state.novel_service = NovelService()\n\n# --- í—¬í¼ í•¨ìˆ˜ ---\ndef reset_ui_state():\n    \"\"\"ìƒˆ ì†Œì„¤ì„ ì‹œì‘í•˜ê±°ë‚˜ ë¶ˆëŸ¬ì˜¬ ë•Œ UI ìƒíƒœ ì´ˆê¸°í™”\"\"\"\n    st.session_state.current_novel = None\n    st.session_state.character_list = []\n    st.session_state.new_char_name = \"\"\n    st.session_state.new_char_personality = \"\"\n    st.session_state.new_char_appearance = \"\"\n    st.session_state.selected_chapter_title = None\n\ndef load_novel_to_session(novel_title):\n    \"\"\"ì„ íƒëœ ì†Œì„¤ì„ ì„¸ì…˜ ìƒíƒœë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜\"\"\"\n    novel_service = st.session_state.novel_service\n    novel = novel_service.load_novel(novel_title)\n    if novel:\n        st.session_state.current_novel = novel\n        st.session_state.character_list = novel.settings.characters\n        st.success(f\"'{novel_title}' ì†Œì„¤ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\")\n    else:\n        st.error(\"ì†Œì„¤ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\")\n        reset_ui_state()\n\n# --- ì‚¬ì´ë“œë°” UI ---\nwith st.sidebar:\n    st.title(\"ğŸ“š AI ì†Œì„¤ ì–´ì‹œìŠ¤í„´íŠ¸\")\n    st.markdown(\"---\")\n\n    st.header(\"ìƒˆ ì†Œì„¤ ì‹œì‘\")\n    new_novel_title = st.text_input(\"ì†Œì„¤ ì œëª© ì…ë ¥\", key=\"new_novel_title_input\")\n    if st.button(\"ìƒˆ ì†Œì„¤ ë§Œë“¤ê¸°\"):\n        if new_novel_title:\n            reset_ui_state()\n            novel_service = st.session_state.novel_service\n            novel = novel_service.create_new_novel(new_novel_title)\n            st.session_state.current_novel = novel\n            st.success(f\"ìƒˆ ì†Œì„¤ '{new_novel_title}' ìƒì„± ì™„ë£Œ! ì„¤ì •ì„ ì‹œì‘í•˜ì„¸ìš”.\")\n        else:\n            st.warning(\"ì†Œì„¤ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\")\n\n    st.markdown(\"---\")\n    st.header(\"ì†Œì„¤ ë¶ˆëŸ¬ì˜¤ê¸°\")\n    \n    novel_service = st.session_state.novel_service\n    available_novels = novel_service.list_novels()\n    \n    selected_novel_to_load = st.selectbox(\n        \"ë¶ˆëŸ¬ì˜¬ ì†Œì„¤ ì„ íƒ\",\n        options=[\"\"] + available_novels,\n        key=\"load_novel_select\"\n    )\n\n    if st.button(\"ì„ íƒí•œ ì†Œì„¤ ë¶ˆëŸ¬ì˜¤ê¸°\"):\n        if selected_novel_to_load:\n            reset_ui_state()\n            load_novel_to_session(selected_novel_to_load)\n        else:\n            st.warning(\"ë¶ˆëŸ¬ì˜¬ ì†Œì„¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”.\")\n\n# --- ë©”ì¸ í˜ì´ì§€ UI ---\nif 'current_novel' not in st.session_state:\n    st.session_state.current_novel = None\n\nif st.session_state.current_novel:\n    novel = st.session_state.current_novel\n    st.header(f\"ğŸ“– í˜„ì¬ ì‘ì—…ì¤‘ì¸ ì†Œì„¤: {novel.title}\")\n\n    # ì†Œì„¤ ìƒì„± ì „ ì„¤ì • íƒ­\n    if not novel.chapters:\n        st.info(\"ì†Œì„¤ ìƒì„±ì„ ì‹œì‘í•˜ê¸° ì „ì— ì•„ë˜ ì„¤ì •ì„ ì™„ë£Œí•˜ê³  'í”„ë¡¤ë¡œê·¸ ìƒì„±' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.\")\n        \n        settings_tab, characters_tab = st.tabs([\"ê¸°ë³¸ ì„¤ì •\", \"ë“±ì¥ì¸ë¬¼\"])\n\n        with settings_tab:\n            st.subheader(\"ê¸°ë³¸ ì„¤ì •\")\n            novel.settings.style = st.text_area(\"ë¬¸ì²´\", value=novel.settings.style, placeholder=\"ì˜ˆ: ê±´ì¡°í•˜ê³  ê°„ê²°í•œ ë¬¸ì²´, í™”ë ¤í•˜ê³  ì‹œì ì¸ ë¬˜ì‚¬\")\n            novel.settings.pov = st.selectbox(\"ì‹œì \", [\"1ì¸ì¹­ ì£¼ì¸ê³µ\", \"3ì¸ì¹­ ê´€ì°°ì\", \"3ì¸ì¹­ ì „ì§€ì \"], index=2)\n            \n            col1, col2, col3 = st.columns(3)\n            with col1:\n                novel.settings.time_bg = st.text_input(\"ì‹œê°„ì  ë°°ê²½\", value=novel.settings.time_bg, placeholder=\"ì˜ˆ: 2077ë…„, ê·¼ë¯¸ë˜\")\n            with col2:\n                novel.settings.space_bg = st.text_input(\"ê³µê°„ì  ë°°ê²½\", value=novel.settings.space_bg, placeholder=\"ì˜ˆ: ì‚¬ì´ë²„í‘í¬ ë„ì‹œ 'ë„¤ì˜¤-ì„œìš¸'\")\n            with col3:\n                novel.settings.social_bg = st.text_input(\"ì‚¬íšŒì  ë°°ê²½\", value=novel.settings.social_bg, placeholder=\"ì˜ˆ: ê±°ëŒ€ ê¸°ì—…ì´ ëª¨ë“  ê²ƒì„ ì§€ë°°í•˜ëŠ” ì‚¬íšŒ\")\n\n            novel.settings.prologue_length = st.number_input(\"í”„ë¡¤ë¡œê·¸ ë¶„ëŸ‰ (ë‹¨ì–´ ìˆ˜)\", min_value=100, max_value=2000, value=novel.settings.prologue_length, step=100)\n            novel.settings.chapter_length = st.number_input(\"ì±•í„°ë‹¹ í‰ê·  ë¶„ëŸ‰ (ë‹¨ì–´ ìˆ˜)\", min_value=100, max_value=3000, value=novel.settings.chapter_length, step=100)\n\n        with characters_tab:\n            st.subheader(\"ë“±ì¥ì¸ë¬¼ ê´€ë¦¬\")\n            \n            if 'character_list' not in st.session_state:\n                st.session_state.character_list = novel.settings.characters\n\n            # ë“±ì¥ì¸ë¬¼ ëª©ë¡ í‘œì‹œ\n            for i, char in enumerate(st.session_state.character_list):\n                with st.expander(f\"**{char.name}**\"):\n                    st.write(f\"**ì„±ê²©:** {', '.join(char.personality)}\")\n                    st.write(f\"**ì™¸ëª¨:** {', '.join(char.appearance)}\")\n                    if st.button(f\"{char.name} ì‚­ì œ\", key=f\"del_char_{i}\"):\n                        st.session_state.character_list.pop(i)\n                        novel.settings.characters = st.session_state.character_list\n                        st.rerun()\n\n            st.markdown(\"---\")\n            st.subheader(\"ìƒˆ ë“±ì¥ì¸ë¬¼ ì¶”ê°€\")\n            \n            with st.form(\"new_char_form\", clear_on_submit=True):\n                char_name = st.text_input(\"ì´ë¦„\", key=\"new_char_name\")\n                \n                # í‚¤ì›Œë“œ ì…ë ¥ì„ ìœ„í•œ ë©€í‹°ì…€ë ‰íŠ¸ êµ¬í˜„\n                personality_keywords_str = st.text_input(\"ì„±ê²© í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)\", key=\"new_char_personality\")\n                appearance_keywords_str = st.text_input(\"ì™¸ëª¨ í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)\", key=\"new_char_appearance\")\n\n                submitted = st.form_submit_button(\"ë“±ì¥ì¸ë¬¼ ì¶”ê°€\")\n                if submitted and char_name:\n                    personality = [k.strip() for k in personality_keywords_str.split(',') if k.strip()]\n                    appearance = [k.strip() for k in appearance_keywords_str.split(',') if k.strip()]\n                    new_char = Character(name=char_name, personality=personality, appearance=appearance)\n                    st.session_state.character_list.append(new_char)\n                    novel.settings.characters = st.session_state.character_list\n                    st.success(f\"ë“±ì¥ì¸ë¬¼ '{char_name}' ì¶”ê°€ ì™„ë£Œ!\")\n\n        st.markdown(\"---\")\n        if st.button(\"âœ¨ í”„ë¡¤ë¡œê·¸ ìƒì„± ì‹œì‘\", type=\"primary\", use_container_width=True):\n            with st.spinner(\"Gemini 2.5 Flashê°€ í”„ë¡¤ë¡œê·¸ë¥¼ ì°½ì‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...\"):\n                try:\n                    novel_service.generate_prologue(novel)\n                    st.success(\"í”„ë¡¤ë¡œê·¸ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\")\n                    st.rerun()\n                except Exception as e:\n                    st.error(f\"í”„ë¡¤ë¡œê·¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}\")\n\n    # ì†Œì„¤ ìƒì„± í›„ ë·°\n    else:\n        col1, col2 = st.columns([2, 1])\n        \n        with col1:\n            st.subheader(\"ğŸ“œ ì†Œì„¤ ë³¸ë¬¸\")\n            \n            chapter_titles = [f\"í”„ë¡¤ë¡œê·¸\"] + [f\"ì±•í„° {i+1}\" for i in range(len(novel.chapters) - 1)]\n            \n            if 'selected_chapter_title' not in st.session_state or st.session_state.selected_chapter_title is None:\n                st.session_state.selected_chapter_title = chapter_titles[-1]\n\n            def on_chapter_select():\n                st.session_state.selected_chapter_title = st.session_state.chapter_selector\n            \n            st.selectbox(\n                \"ì—´ëŒí•  ì±•í„° ì„ íƒ\", \n                options=chapter_titles, \n                index=chapter_titles.index(st.session_state.selected_chapter_title),\n                key=\"chapter_selector\",\n                on_change=on_chapter_select\n            )\n\n            selected_index = chapter_titles.index(st.session_state.selected_chapter_title)\n            st.markdown(f\"### {st.session_state.selected_chapter_title}\")\n            st.markdown(novel.chapters[selected_index].content.replace(\"\\n\", \"\\n\\n\"))\n\n        with col2:\n            st.subheader(\"âš™ï¸ ì‘ì—… ê´€ë¦¬\")\n            \n            if st.button(\"ë‹¤ìŒ ì±•í„° ìƒì„±\", use_container_width=True):\n                with st.spinner(\"ë‹¤ìŒ ì±•í„°ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...\"):\n                    try:\n                        novel_service.generate_next_chapter(novel)\n                        st.session_state.selected_chapter_title = f\"ì±•í„° {len(novel.chapters) - 1}\"\n                        st.success(\"ë‹¤ìŒ ì±•í„° ìƒì„± ì™„ë£Œ!\")\n                        st.rerun()\n                    except Exception as e:\n                        st.error(f\"ì±•í„° ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}\")\n\n            if st.button(\"ğŸ’¾ í˜„ì¬ ì†Œì„¤ ì €ì¥\", use_container_width=True):\n                with st.spinner(\"ì†Œì„¤ì„ ì €ì¥í•˜ëŠ” ì¤‘...\"):\n                    try:\n                        novel_service.save_novel(novel)\n                        st.success(\"ì†Œì„¤ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\")\n                    except Exception as e:\n                        st.error(f\"ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}\")\n\n            st.markdown(\"---\")\n            st.subheader(\"ğŸ§  ì†Œì„¤ ë©”ëª¨ë¦¬ (ìš”ì•½)\")\n            st.text_area(\"ìš”ì•½\", value=novel.summary, height=200, disabled=True)\n\nelse:\n    st.info(\"ğŸ‘ˆ ì‚¬ì´ë“œë°”ì—ì„œ 'ìƒˆ ì†Œì„¤ ë§Œë“¤ê¸°'ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê¸°ì¡´ ì†Œì„¤ì„ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.\")","outputs":[],"execution_count":null,"metadata":{}}],"metadata":{"colab":{"from_bard":true},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}